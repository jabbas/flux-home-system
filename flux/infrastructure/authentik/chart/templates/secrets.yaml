{{- $fullname := include "authentik-stack.fullname" . -}}
{{- $oidcClientSecret := include "authentik-stack.secretValue" (dict "Release" .Release "value" .Values.oidc.clientSecret "secretName" (printf "%s-oidc-talos" $fullname) "key" "AUTHENTIK_TALOS_SECRET" "length" 32) -}}
{{- $grafanaClientSecret := include "authentik-stack.secretValue" (dict "Release" .Release "value" .Values.oidc.grafana.clientSecret "secretName" (printf "%s-oidc-grafana" $fullname) "key" "AUTHENTIK_GRAFANA_SECRET" "length" 32) -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-admin
  labels:
    {{- include "authentik-stack.componentLabels" (dict "context" . "component" "secrets") | nindent 4 }}
type: Opaque
stringData:
  AUTHENTIK_SECRET_KEY: {{ include "authentik-stack.secretValue" (dict "Release" .Release "value" .Values.admin.secretKey "secretName" (printf "%s-admin" $fullname) "key" "AUTHENTIK_SECRET_KEY" "length" 64) | quote }}
  AUTHENTIK_BOOTSTRAP_PASSWORD: {{ include "authentik-stack.secretValue" (dict "Release" .Release "value" .Values.admin.password "secretName" (printf "%s-admin" $fullname) "key" "AUTHENTIK_BOOTSTRAP_PASSWORD" "length" 32) | quote }}
  AUTHENTIK_BOOTSTRAP_TOKEN: {{ include "authentik-stack.secretValue" (dict "Release" .Release "value" .Values.admin.token "secretName" (printf "%s-admin" $fullname) "key" "AUTHENTIK_BOOTSTRAP_TOKEN" "length" 32) | quote }}
  AUTHENTIK_BOOTSTRAP_EMAIL: {{ required "admin.email is required" .Values.admin.email | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-oidc-talos
  labels:
    {{- include "authentik-stack.componentLabels" (dict "context" . "component" "secrets") | nindent 4 }}
type: Opaque
stringData:
  AUTHENTIK_TALOS_SECRET: {{ $oidcClientSecret | quote }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-oidc-headlamp
  labels:
    {{- include "authentik-stack.componentLabels" (dict "context" . "component" "secrets") | nindent 4 }}
  {{- if .Values.oidc.headlamp.reflector.enabled }}
  annotations:
    reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
    reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: {{ .Values.oidc.headlamp.reflector.targetNamespace | quote }}
  {{- end }}
type: Opaque
stringData:
  OIDC_CLIENT_ID: talos-cluster-id
  OIDC_CLIENT_SECRET: {{ $oidcClientSecret | quote }}
  OIDC_ISSUER_URL: https://{{ (index .Values.authentik.server.ingress.hosts 0) }}/application/o/talos-cluster/
  OIDC_SCOPES: "openid,profile,email,groups"
---
# Grafana OIDC secret - loaded by Authentik for blueprint
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-oidc-grafana
  labels:
    {{- include "authentik-stack.componentLabels" (dict "context" . "component" "secrets") | nindent 4 }}
type: Opaque
stringData:
  AUTHENTIK_GRAFANA_SECRET: {{ $grafanaClientSecret | quote }}
---
# Grafana OAuth secret - reflected to grafana namespace
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-grafana-oauth
  labels:
    {{- include "authentik-stack.componentLabels" (dict "context" . "component" "secrets") | nindent 4 }}
  {{- if .Values.oidc.grafana.reflector.enabled }}
  annotations:
    reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
    reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: {{ .Values.oidc.grafana.reflector.targetNamespace | quote }}
  {{- end }}
type: Opaque
stringData:
  GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET: {{ $grafanaClientSecret | quote }}
