apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "authentik-blueprints.fullname" . }}-victoria-metrics
  labels:
    {{- include "authentik-blueprints.componentLabels" (dict "context" . "component" "victoria-metrics") | nindent 4 }}
data:
  victoria-metrics.yaml: |
    version: 1
    metadata:
      name: Victoria Metrics Proxy Setup
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # Proxy provider for forwardAuth with Traefik
      - model: authentik_providers_proxy.proxyprovider
        id: victoria-metrics-provider
        identifiers:
          name: Victoria Metrics Proxy
        attrs:
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          external_host: https://vmui.dev.home
          mode: forward_single
          access_token_validity: hours=24

      # Application
      - model: authentik_core.application
        id: victoria-metrics-app
        identifiers:
          slug: victoria-metrics
        attrs:
          name: Victoria Metrics
          icon: {{ .Values.oidc.victoriaMetrics.icon | quote }}
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, "Victoria Metrics Proxy"]]

      # Policy binding for access control
      - model: authentik_policies.policybinding
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, victoria-metrics]]
          group: !Find [authentik_core.group, [name, monitoring-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30

      # Bind provider to the embedded outpost
      - model: authentik_outposts.outpostproviderconfig
        identifiers:
          outpost: !Find [authentik_outposts.outpost, [name, "authentik Embedded Outpost"]]
          provider: !Find [authentik_providers_proxy.proxyprovider, [name, "Victoria Metrics Proxy"]]
        attrs:
          order: 0
