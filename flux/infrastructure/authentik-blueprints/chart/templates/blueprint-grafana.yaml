apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "authentik-blueprints.fullname" . }}-grafana
  labels:
    {{- include "authentik-blueprints.componentLabels" (dict "context" . "component" "grafana") | nindent 4 }}
data:
  grafana.yaml: |
    version: 1
    metadata:
      name: Grafana OAuth Setup
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # OAuth2 provider for Grafana
      - model: authentik_providers_oauth2.oauth2provider
        id: grafana-provider
        identifiers:
          name: Grafana OAuth
        attrs:
          client_id: {{ .Values.oidc.grafana.clientId | quote }}
          client_secret: !Env [AUTHENTIK_GRAFANA_SECRET, "fallback-secret"]
          client_type: confidential
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          redirect_uris:
            - url: https://grafana.dev.home/login/generic_oauth
              matching_mode: strict
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
            - !Find [authentik_providers_oauth2.scopemapping, [name, "Kubernetes Groups Mapping"]]
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
          sub_mode: user_username

      # Application
      - model: authentik_core.application
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          icon: {{ .Values.oidc.grafana.icon | quote }}
          provider: !Find [authentik_providers_oauth2.oauth2provider, [name, "Grafana OAuth"]]

      # Policy binding - monitoring-admins group
      - model: authentik_policies.policybinding
        identifiers:
          order: 0
          target: !Find [authentik_core.application, [slug, grafana]]
          group: !Find [authentik_core.group, [name, monitoring-admins]]
        attrs:
          enabled: true
          negate: false
          timeout: 30
