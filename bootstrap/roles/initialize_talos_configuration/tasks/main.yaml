---
- name: Generate configuration using secrets.yaml
  connection: local
  ansible.builtin.shell: "talosctl gen config {{ talos.cluster_name }} {{ talos.endpoint }} --with-secrets {{ talos.secrets_path }} --with-examples=true --with-docs=false --install-disk {{ talos.boot_disk }} --additional-sans {{ groups['all'] | join(',') }} --force"
  changed_when: false

- name: Authentik Pre-Shared Key File check
  connection: local
  ansible.builtin.stat:
    path: authentik.preshared.key
  register: authentik_preshared_key_check

- name: Generate Authentik Pre-Shared Key
  when:
    not authentik_preshared_key_check.stat.exists
  block:
    - name: Generate Authentik Pre-Shared Key
      connection: local
      ansible.builtin.shell: "openssl rand -hex 16"
      register: authentik_preshared_key
      changed_when: false

    - name: Save Authentik Pre-Shared Key to disk
      connection: local
      ansible.builtin.copy:
        content: "{{ authentik_preshared_key.stdout }}"
        dest: "authentik.preshared.key"
        mode: '0644'

- name: Update talosconfig with first endpoint
  connection: local
  ansible.builtin.shell: "talosctl --talosconfig talosconfig config endpoint {{ groups['all'][0] }}"
  changed_when: false

- name: Check if nodes is already provisioned
  block:
    - name: Get version
      ansible.builtin.shell: "talosctl --talosconfig talosconfig --nodes {{ item }} get version -o jsonpath='{.node}'"
      register: node_versions
      loop: "{{ groups['all'] }}"
      ignore_errors: true
      failed_when: false
      changed_when: false
    - name: Prepare the dict of already provisioned nodes
      set_fact:
        already_provisioned_nodes: "{{ already_provisioned_nodes | default({}) | combine({ (item.item): (item.item == item.stdout) }) }}"
      loop: "{{ node_versions.results }}"

- name: Apply patches
  ansible.builtin.shell: |
    talosctl --talosconfig talosconfig --nodes {{ item }} apply {{ '--insecure' if not already_provisioned_nodes[item] else '' }} -f controlplane.yaml \
      -p 'machine:
        install:
          image: factory.talos.dev/metal-installer/{{ talos.schematic_id }}:v{{ talos.version }}' \
      -p @patch/allow-scheduling.yaml \
      -p @patch/remove-externallb-label.yaml \
      -p @patch/oidc.yaml
  loop: "{{ groups['all'] }}"
  changed_when: false

- name: Wait for Talos install to be ready
  ansible.builtin.wait_for:
    host: "{{ item }}"
    port: 50001
  loop: "{{ groups['all'] }}"

- name: Bootstrap on the first node
  ansible.builtin.shell: "talosctl --talosconfig talosconfig --nodes {{ groups['all'][0] }} bootstrap"
  when: already_provisioned_nodes.values() |select('equalto', false) |list |length==already_provisioned_nodes |length
  changed_when: false

- name: Wait for Talos bootstrap to be completed (kubeapi is ready)
  ansible.builtin.wait_for:
    host: "{{ item }}"
    port: 6443
  loop: "{{ groups['all'] }}"
  timeout: 400

- name: Update talosconfig with endpoint
  connection: local
  ansible.builtin.shell: "talosctl --talosconfig talosconfig config endpoint {{ groups['all'] | join(' ') }}"
  changed_when: false

- name: Create \$HOME/.talos directory if it doesn't exist
  ansible.builtin.file:
    path: "$HOME/.talos"
    state: directory
    mode: '0750'

- name: Copy talosconfig to \$HOME/.talos/config
  connection: local
  ansible.builtin.copy:
    src: talosconfig
    dest: "$HOME/.talos/config"
    mode: '0644'

- name: Generate kubectl config
  connection: local
  ansible.builtin.shell: "talosctl --nodes {{ groups['all'][0] }} --endpoints {{ groups['all'][0] }} kubeconfig"
  changed_when: false

- name: Provision it with flux
  connection: local
  kubernetes.core.k8s:
    state: present
    src: "{{ item }}"
  loop: "{{ lookup('fileglob', playbook_dir + '/provision/*.yaml', wantlist=True) | sort }}"
